<!DOCTYPE html>
<html>
<head>
    <title>Finance Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: radial-gradient(circle at 20% 30%, #1e293b, #0f172a 60%);
    color: #fff;
}

.container {
    max-width: 620px;
    margin: 80px auto;
    padding: 0 20px;
}

h1 {
    text-align: center;
    font-size: 36px;
    font-weight: 600;
    margin-bottom: 10px;
    letter-spacing: 1px;
}

.lang-switch {
    text-align: center;
    margin-bottom: 40px;
}

.lang-switch a {
    color: #94a3b8;
    text-decoration: none;
    margin: 0 8px;
    font-size: 14px;
    transition: 0.3s;
}

.lang-switch a:hover {
    color: #fff;
}

.card {
    backdrop-filter: blur(18px);
    background: rgba(255,255,255,0.08);
    border-radius: 24px;
    padding: 28px;
    margin-bottom: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    transition: 0.3s ease;
}

.card:hover { transform: translateY(-3px); }

h2 { margin-top: 0; font-weight: 500; }

input {
    width: 100%;
    padding: 14px;
    margin-bottom: 14px;
    border-radius: 14px;
    border: none;
    background: rgba(255,255,255,0.12);
    color: white;
    outline: none;
    font-size: 16px;

    /* ğŸ”¥ iOS Fix */
    appearance: none;
    -webkit-appearance: none;
    box-sizing: border-box;
}

input::placeholder { color: rgba(255,255,255,0.6); }

button {
    padding: 14px;
    border-radius: 14px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    font-size: 14px;
    transition: 0.3s;
}

.btn-primary {
    width: 100%;
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    color: white;
}

.btn-primary:hover { opacity: 0.85; }

.btn-delete {
    background: rgba(255,99,132,0.8);
    color: white;
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 12px;
}

.btn-delete:hover { background: rgba(255,99,132,1); }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th {
    text-align: left;
    font-size: 12px;
    color: rgba(255,255,255,0.6);
}

td {
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.income { color: #4ade80; font-weight: 500; }
.expense { color: #f87171; font-weight: 500; }

ul { padding-left: 16px; }

.ai-box {
    margin-top: 20px;
    padding: 20px;
    border-radius: 20px;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(10px);
    line-height: 1.6;
}
</style>
</head>

<body>

<div class="container">

{% set text = {
    "en": {
        "title": "Finance Tracker",
        "add": "Add Transaction",
        "amount_placeholder": "Amount (use negative for expenses)",
        "category_placeholder": "Category",
        "delete": "Delete",
        "transactions": "All Transactions",
        "summary": "Monthly Summary",
        "average": "Average Monthly Net",
        "volatility": "Monthly Volatility",
        "forecast": "Forecast (Next 3 Months)",
        "ai_button": "AI Suggestion",
        "ai_loading": "Analyzing your financial profile...",
        "no_transactions": "No transactions yet.",
        "no_monthly": "No monthly data yet."
    },
    "zh": {
        "title": "è´¢åŠ¡ç®¡ç†",
        "add": "æ·»åŠ äº¤æ˜“",
        "amount_placeholder": "é‡‘é¢ï¼ˆæ”¯å‡ºè¯·è¾“å…¥è´Ÿæ•°ï¼‰",
        "category_placeholder": "ç±»åˆ«",
        "delete": "åˆ é™¤",
        "transactions": "æ‰€æœ‰äº¤æ˜“",
        "summary": "æœˆåº¦æ€»ç»“",
        "average": "æœˆå¹³å‡å‡€æ”¶å…¥",
        "volatility": "æœˆæ³¢åŠ¨ç‡",
        "forecast": "æœªæ¥ä¸‰ä¸ªæœˆé¢„æµ‹",
        "ai_button": "AI è´¢åŠ¡å»ºè®®",
        "ai_loading": "æ­£åœ¨åˆ†ææ‚¨çš„è´¢åŠ¡çŠ¶å†µ...",
        "no_transactions": "æš‚æ— äº¤æ˜“è®°å½•",
        "no_monthly": "æš‚æ— æœˆåº¦æ•°æ®"
    }
} %}

<h1>{{ text[lang]["title"] }}</h1>

<div class="lang-switch">
    <a href="/?lang=en">English</a> |
    <a href="/?lang=zh">ä¸­æ–‡</a>
</div>

<!-- Add Transaction -->
<div class="card">
    <h2>{{ text[lang]["add"] }}</h2>
    <form action="/add" method="post">
        <input type="hidden" name="lang" value="{{ lang }}">
        <input type="date" name="date" required>
        <input type="number" step="0.01" name="amount"
               placeholder="{{ text[lang]['amount_placeholder'] }}" required>
        <input type="text" name="category"
               placeholder="{{ text[lang]['category_placeholder'] }}" required>
        <button class="btn-primary">{{ text[lang]["add"] }}</button>
    </form>
</div>

<!-- Transactions -->
<div class="card">
    <h2>{{ text[lang]["transactions"] }}</h2>

    {% if transactions %}
    <table>
        <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Amount</th>
            <th></th>
        </tr>

        {% for t in transactions %}
        <tr {% if t.id in anomalies %}style="background: rgba(255,0,0,0.15);" {% endif %}>
            <td>{{ t.date }}</td>
            <td>{{ t.category }}</td>
            <td class="{% if t.amount_cents > 0 %}income{% else %}expense{% endif %}">
                ${{ "%.2f"|format(t.amount_cents / 100) }}
            </td>
            <td>
                <form action="/delete/{{ t.id }}" method="post">
                    <input type="hidden" name="lang" value="{{ lang }}">
                    <button class="btn-delete">{{ text[lang]["delete"] }}</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
        <p>{{ text[lang]["no_transactions"] }}</p>
    {% endif %}
</div>

<!-- Monthly Summary -->
<div class="card">
    <h2>{{ text[lang]["summary"] }}</h2>

    {% if months %}
        <ul>
            {% for i in range(months|length) %}
                <li>{{ months[i] }} : ${{ "%.2f"|format(totals[i] / 100) }}</li>
            {% endfor %}
        </ul>

        <p><strong>{{ text[lang]["average"] }}:</strong>
            ${{ "%.2f"|format(avg / 100) }}</p>

        <p><strong>{{ text[lang]["volatility"] }}:</strong>
            ${{ "%.2f"|format(std / 100) }}</p>

        {% if predictions and predictions|length > 0 %}
            <h3>{{ text[lang]["forecast"] }}</h3>
            <ul>
                {% for p in predictions %}
                    <li>${{ "%.2f"|format(p / 100) }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <!-- AI Section -->
        <div style="margin-top:25px;">
            <button id="ai-btn" class="btn-primary">
                ğŸ¤– {{ text[lang]["ai_button"] }}
            </button>

            <div id="ai-result" class="ai-box"></div>
        </div>

    {% else %}
        <p>{{ text[lang]["no_monthly"] }}</p>
    {% endif %}
</div>

</div>

<script>
document.getElementById("ai-btn")?.addEventListener("click", function() {
    const resultBox = document.getElementById("ai-result");
    resultBox.innerHTML = "{{ text[lang]['ai_loading'] }}";

    fetch("/ai-advice", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "lang={{ lang }}"
    })
    .then(response => response.json())
    .then(data => {
        resultBox.innerHTML = data.advice.replace(/\n/g, "<br>");
    })
    .catch(() => {
        resultBox.innerHTML = "Error generating advice.";
    });
});
</script>

</body>
</html>
